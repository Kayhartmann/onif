#!/usr/bin/with-contenv bashio
# ==============================================================================
# 30-go2rtc-config.sh
# Generates go2rtc.yaml from HA add-on options (/data/options.json)
# ==============================================================================
set -e

bashio::log.info "Generating go2rtc configuration..."

# Read actual ports selected by 05-port-selection.sh
NEOLINK_PORT=$(jq -r '.neolink'     /tmp/actual-ports.json)
GO2RTC_PORT=$(jq  -r '.go2rtc_rtsp' /tmp/actual-ports.json)
GO2RTC_API=$(jq   -r '.go2rtc_api'  /tmp/actual-ports.json)
CONFIG_FILE="/data/go2rtc/go2rtc.yaml"

mkdir -p /data/go2rtc

# Build streams section
# All cameras are routed through Neolink (Baichuan protocol on port 9000 to camera).
# Neolink exposes an RTSP server which go2rtc consumes.
STREAMS_YAML=""
CAMERA_COUNT=$(bashio::config 'cameras | length')

if bashio::config.exists 'cameras'; then
    for i in $(seq 0 $((CAMERA_COUNT - 1))); do
        CAM_NAME=$(bashio::config "cameras[${i}].name")

        # has_substream: false â†’ use main stream as sub fallback (for battery cameras
        # like Argus Pro that only expose a main stream via neolink/Baichuan)
        HAS_SUB=$(bashio::config "cameras[${i}].has_substream" 2>/dev/null || echo "true")
        if [ "${HAS_SUB}" = "null" ] || [ -z "${HAS_SUB}" ]; then
            HAS_SUB="true"
        fi

        if [ "${HAS_SUB}" = "true" ]; then
            SUB_PATH="${CAM_NAME}/sub"
        else
            SUB_PATH="${CAM_NAME}/main"
            bashio::log.info "  Camera ${CAM_NAME}: no substream configured, using main as fallback"
        fi

        bashio::log.info "  Adding go2rtc stream: ${CAM_NAME}"
        STREAMS_YAML="${STREAMS_YAML}
  ${CAM_NAME}: rtsp://127.0.0.1:${NEOLINK_PORT}/${CAM_NAME}/main
  ${CAM_NAME}_sub: rtsp://127.0.0.1:${NEOLINK_PORT}/${SUB_PATH}"
    done
fi

cat > "${CONFIG_FILE}" << EOF
# go2rtc configuration - Auto-generated by Reolink UniFi Bridge
# DO NOT EDIT - Changes will be overwritten on restart.

api:
  listen: "127.0.0.1:${GO2RTC_API}"
  base_path: ""

rtsp:
  listen: "0.0.0.0:${GO2RTC_PORT}"

log:
  level: warn

streams:${STREAMS_YAML}
EOF

bashio::log.info "go2rtc configuration written to ${CONFIG_FILE}"
