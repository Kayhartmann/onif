#!/usr/bin/with-contenv bashio
# ==============================================================================
# Service: onvif-server (Virtual ONVIF cameras for UniFi Protect)
# Uses daniela-hase/onvif-server â€” start command: node /app/main.js <config>
# Config file: /data/onvif.yaml (YAML format, generated by 60-onvif-config.sh)
# ==============================================================================

GO2RTC_PORT=$(bashio::config 'go2rtc_port')

bashio::log.info "Waiting for go2rtc RTSP to be ready on port ${GO2RTC_PORT}..."
wait-for-port 127.0.0.1 "${GO2RTC_PORT}" 60 || {
    bashio::log.warning "go2rtc not ready after 60s, starting ONVIF server anyway..."
}

CONFIG_FILE="/data/onvif.yaml"

if [ ! -f "${CONFIG_FILE}" ]; then
    bashio::log.error "ONVIF config file not found: ${CONFIG_FILE}"
    exit 1
fi

bashio::log.info "Starting ONVIF server with config: ${CONFIG_FILE}"

# daniela-hase/onvif-server opens wsdl/ relative to its working directory
cd /app
exec node /app/main.js "${CONFIG_FILE}"
